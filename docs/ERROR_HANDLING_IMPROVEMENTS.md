# エラーハンドリング改善まとめ

## 📋 実装した改善

### 1. SSE接続のエラーハンドリング改善

#### `ERR_NETWORK_IO_SUSPENDED` の処理
- **問題**: ページがバックグラウンドにある時に発生するエラーがコンソールに表示される
- **解決策**: ページの可視性をチェックし、バックグラウンド時はエラーとして扱わない
- **実装**: `useMessageStream.ts` と `useNotificationStream.ts` にページ可視性APIを追加

#### ページ可視性APIの活用
- ページがバックグラウンドにある時: SSE接続を一時停止（ブラウザが自動的に中断）
- ページがフォアグラウンドに戻った時: 自動的に再接続
- **効果**: バッテリー消費の削減、不要なエラーログの削減

---

### 2. DNS解決エラーのリトライ改善

#### `ERR_NAME_NOT_RESOLVED` の処理
- **問題**: 一時的なDNS問題でAPIリクエストが失敗する
- **解決策**: DNS解決エラーを検出し、自動的にリトライ
- **実装**: `api/client.ts` にDNSエラー検出ロジックを追加

#### 検出するエラーコード
- `ENOTFOUND`
- `EAI_AGAIN`
- `ERR_NAME_NOT_RESOLVED`
- `getaddrinfo` を含むエラーメッセージ

---

### 3. エラーログの最適化

#### コンソールノイズの削減
- SSE接続エラーはverboseモードでのみログ出力
- 正常な動作（ページバックグラウンドなど）はエラーとして扱わない
- **効果**: 開発者ツールのコンソールがクリーンに保たれる

---

## 🔍 エラーの種類と対処

### 正常な動作（エラーとして扱わない）

1. **ERR_NETWORK_IO_SUSPENDED**
   - 原因: ページがバックグラウンドにある
   - 対処: ページがフォアグラウンドに戻った時に自動再接続
   - ログ: verboseモードでのみ

2. **SSE接続の一時的な中断**
   - 原因: ネットワークの一時的な問題
   - 対処: 自動リトライ（指数バックオフ）
   - ログ: verboseモードでのみ

### エラーとして処理する

1. **ERR_NAME_NOT_RESOLVED**
   - 原因: DNS解決の失敗
   - 対処: 自動リトライ（最大2回）
   - ログ: 通常モードでもログ出力

2. **タイムアウトエラー**
   - 原因: サーバーが30秒以内に応答しない
   - 対処: 自動リトライ（最大2回、指数バックオフ）
   - ログ: 通常モードでもログ出力

---

## 📊 改善効果

### Before（改善前）
- コンソールに大量のエラーログが表示される
- 正常な動作がエラーとして表示される
- DNSエラー時にリトライされない

### After（改善後）
- コンソールがクリーンに保たれる
- 正常な動作はエラーとして扱われない
- DNSエラー時に自動リトライされる
- ページがバックグラウンドにある時はSSE接続を一時停止

---

## 🧪 テスト方法

### Verboseモードの有効化

SSE接続の詳細ログを確認する場合：

```javascript
// ブラウザのコンソールで実行
localStorage.setItem('debugSSE', 'true');
// ページをリロード
```

### エラーの再現テスト

1. **DNSエラーのテスト**
   - ネットワーク設定で一時的にDNSを無効化
   - APIリクエストが自動的にリトライされることを確認

2. **ページ可視性のテスト**
   - ページを開いた状態で別のタブに切り替え
   - `ERR_NETWORK_IO_SUSPENDED`がエラーとして表示されないことを確認
   - 元のタブに戻った時に自動的に再接続されることを確認

---

## 📝 関連ファイル

- `frontend/lib/hooks/useMessageStream.ts` - メッセージSSE接続
- `frontend/lib/hooks/useNotificationStream.ts` - 通知SSE接続
- `frontend/lib/api/client.ts` - APIクライアント（DNSエラーリトライ）
- `docs/SSE_ERROR_ANALYSIS.md` - SSEエラー分析ドキュメント

---

## 🚀 次のステップ

1. **デプロイ**: 変更を本番環境にデプロイ
2. **監視**: エラーログの減少を確認
3. **パフォーマンス**: ページ可視性APIによるバッテリー消費の改善を確認


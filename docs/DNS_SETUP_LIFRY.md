# DNS設定ガイド - lifry.com を Cloud Run に接続

## 前提条件

- Google Cloudプロジェクト: `circles-202510`
- Cloud Runサービス: `disease-community-frontend`（フロントエンド）

## 手順

### ステップ1: Google Cloud Consoleでカスタムドメインマッピングを設定

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. **Cloud Run** → **サービス** → **`disease-community-frontend`** を選択
3. **「カスタムドメイン」タブ**をクリック
4. **「ドメインをマッピング」**をクリック
5. 以下の情報を入力：
   - **ドメイン**: `lifry.com`
   - **パス**: `/`（デフォルト）
6. **「続行」**をクリック
7. **「DNS設定を確認」**画面で、Googleが提供する**IPアドレス**を確認
   - 例: `34.120.xxx.xxx` のような形式
   - このIPアドレスをメモしてください

### ステップ2: DNS設定でAレコードを更新

現在のDNS設定画面で、以下のように設定してください：

#### フロントエンド用（メインドメイン）

**既存のAレコードを更新：**

1. **エントリー名**: `@ (lifry.com)` の行を確認
2. **タイプ**: `A`（既に設定済み）
3. **データ**: Google Cloud Runが提供したIPアドレスに変更
   - 現在: `219.94.129.229`
   - 変更後: `[Google Cloud Runが提供するIPアドレス]`
   - 例: `34.120.xxx.xxx`
4. **DNSチェック**: チェックを入れる（推奨）
5. **TTLの指定**: 必要に応じてチェックを入れる
6. **「保存」**ボタンをクリック

#### バックエンドAPI用（サブドメイン、オプション）

バックエンドAPIもカスタムドメインを設定する場合：

1. **「レコード追加」**セクションを使用
2. **エントリー名**: `api` を入力（`api.lifry.com`になります）
3. **タイプ**: `A` を選択
4. **データ**: Google Cloud Runが提供するバックエンド用のIPアドレスを入力
   - バックエンドサービス（`disease-community-api`）のカスタムドメインマッピングで取得したIPアドレス
5. **DNSチェック**: チェックを入れる（推奨）
6. **「追加」**ボタンをクリック
7. **「保存」**ボタンをクリック

### ステップ3: DNS設定の反映を確認

DNS設定の反映には数分〜数時間かかる場合があります。

確認コマンド：
```bash
# DNS設定を確認
nslookup lifry.com
# または
dig lifry.com

# バックエンドAPI用サブドメインを設定した場合
nslookup api.lifry.com
```

### ステップ4: 環境変数の更新

DNS設定が反映されたら、環境変数を更新：

```bash
./scripts/update-domain-to-lifry.sh
```

## 重要な注意事項

### Aレコード vs CNAMEレコード

- **Aレコード**: IPアドレスを直接指定（現在の設定方法）
- **CNAMEレコード**: 別のドメイン名を参照（例: `ghs.googlehosted.com`）

**Aレコードを使用する場合の注意点：**
- Google Cloud RunのIPアドレスは変更される可能性があります
- IPアドレスが変更された場合、手動でDNS設定を更新する必要があります
- CNAMEレコードの方が管理が簡単です

**推奨設定：**
- メインドメイン（`lifry.com`）: Aレコード（現在の設定を維持）
- サブドメイン（`api.lifry.com`など）: CNAMEレコードまたはAレコード

### HTTPSについて

- Google Cloud Runは自動的にHTTPS証明書を提供します
- `http://lifry.com`でもアクセス可能ですが、`https://lifry.com`も自動的に利用可能になります
- セキュリティのため、HTTPSの使用を推奨します

## トラブルシューティング

### DNS設定が反映されない

1. DNSのTTL設定を確認（通常は3600秒=1時間）
2. 複数のDNSサーバーを使用している場合は、すべて更新
3. `dig lifry.com`コマンドでDNSレコードを確認
4. DNSプロバイダーのキャッシュをクリア

### IPアドレスが変更された場合

1. Google Cloud Consoleで新しいIPアドレスを確認
2. DNS設定画面でAレコードのデータを更新
3. 保存して反映を待つ

### カスタムドメインマッピングが完了しない

1. DNS設定が正しく反映されているか確認
2. Google Cloud Consoleの「カスタムドメイン」タブでエラーメッセージを確認
3. DNS設定の反映に時間がかかる場合があります（最大48時間）





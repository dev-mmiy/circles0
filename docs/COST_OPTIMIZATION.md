# GCP コスト最適化ガイド

## 現在のコスト状況（2025年11月）

### 月間コスト内訳
- **Cloud SQL**: ¥1,728（5%増）
- **Cloud Run**: ¥1,636（使用コスト¥2,429 - 節約¥793）
- **Artifact Registry**: ¥196（232%増）
- **合計**: 約¥3,560/月

### コスト増加の要因
- 11月22日以降にCloud Runのコストが急増
- 本番環境のデプロイ開始による影響
- 現在の設定が過剰な可能性

## 現在のCloud Run設定

### バックエンド
- **メモリ**: 2Gi
- **CPU**: 2
- **最大インスタンス数**: 10
- **タイムアウト**: 600秒（10分）

### フロントエンド
- **メモリ**: 2Gi
- **CPU**: 2
- **最大インスタンス数**: 10
- **タイムアウト**: 600秒（10分）

## コスト削減の提案

### 1. リソース設定の最適化（推奨）

#### バックエンド
```bash
--memory 1Gi      # 2Gi → 1Gi（50%削減）
--cpu 1           # 2 → 1（50%削減）
--max-instances 5 # 10 → 5（最大インスタンス削減）
--timeout 300     # 600 → 300秒（5分）
```

**期待される削減**: 約50-60%のコスト削減

#### フロントエンド
```bash
--memory 512Mi    # 2Gi → 512Mi（75%削減）
--cpu 1           # 2 → 1（50%削減）
--max-instances 3 # 10 → 3（最大インスタンス削減）
--timeout 60      # 600 → 60秒（1分、静的サイトなので短く）
```

**期待される削減**: 約70-80%のコスト削減

### 2. 最小インスタンス数の設定

デフォルトでは最小インスタンス数は0（コールドスタートあり）ですが、必要に応じて設定可能です。

```bash
--min-instances 0  # 明示的に0を設定（コスト削減）
```

**注意**: コールドスタートが発生する可能性がありますが、コスト削減に効果的です。

### 3. リクエスト同時実行数の最適化

```bash
--concurrency 80   # デフォルト80（変更不要）
```

### 4. Artifact Registryの最適化

- 古いイメージの自動削除を設定
- ライフサイクルポリシーの設定

## 実装手順

### Step 1: 設定の段階的変更

1. **まずバックエンドのメモリとCPUを削減**
   - 1Gi + 1 CPUに変更
   - 動作確認

2. **次にフロントエンドを最適化**
   - 512Mi + 1 CPUに変更
   - 動作確認

3. **最大インスタンス数を調整**
   - トラフィックに応じて段階的に削減

### Step 2: モニタリング

- Cloud Runのメトリクスを監視
- メモリ使用率、CPU使用率を確認
- エラー率を確認

### Step 3: パフォーマンステスト

- 負荷テストを実施
- レスポンスタイムを確認
- 必要に応じて設定を微調整

## 期待されるコスト削減効果

### 現在の設定（月額）
- Cloud Run: 約¥1,636
- Cloud SQL: 約¥1,728
- Artifact Registry: 約¥196
- **合計**: 約¥3,560

### 最適化後（推定）
- Cloud Run: 約¥500-800（50-70%削減）
- Cloud SQL: 約¥1,728（変更なし）
- Artifact Registry: 約¥100（ライフサイクルポリシー適用）
- **合計**: 約¥2,300-2,600

**削減額**: 約¥1,000-1,300/月（約30-35%削減）

## 注意事項

1. **段階的な変更**: 一度にすべてを変更せず、段階的に実施
2. **モニタリング**: 変更後は必ずメトリクスを監視
3. **ロールバック準備**: 問題が発生した場合のロールバック手順を準備
4. **パフォーマンス**: コスト削減とパフォーマンスのバランスを考慮

## 参考リンク

- [Cloud Run 料金](https://cloud.google.com/run/pricing)
- [Cloud Run リソース設定](https://cloud.google.com/run/docs/configuring/memory-limits)
- [Cloud Run コスト最適化](https://cloud.google.com/run/docs/tips/general)

